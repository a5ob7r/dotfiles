#!/usr/bin/env bash
#
# Dotfiles installer and uninstaller
#

# Set useful shell options.
set -Cueo pipefail

shopt -s extglob
shopt -s nullglob

readonly filepath="$(realpath "$0")"
readonly self="${filepath##*/}"
readonly parent="${filepath%/*}"

function warning () {
  if [[ -t 2 ]]; then
    local -r prefix='\033[33m'
    local -r suffix='\033[0m'
  else
    local -r prefix=
    local -r suffix=
  fi

  echo -e "${prefix}${*}${suffix}" >&2
}

function error () {
  if [[ -t 2 ]]; then
    local -r prefix='\033[31m'
    local -r suffix='\033[0m'
  else
    local -r prefix=
    local -r suffix=
  fi

  echo -e "${prefix}${*}${suffix}" >&2
}

if ! cd "$parent"; then
  error 'Fail to change directory to script parent.'
  exit 1
fi

function help () {
  echo -e -n "
Descriptions:
  Dotfiles installer and uninstaller

Usage:
  $self <SUBCOMMAND>

Subcommands:
  init         Initialize setup
  deploy       Deploy dotfiles
  undeploy     Remove deployed dotfiles

Options:
  -h, --help   Show this messages and exit.
"
}

readonly bin_srcpath="${parent}/bin"
readonly bin_dstpath=~/bin
readonly config_srcpath="${parent}/.config"
readonly config_dstpath=~/.config
readonly home_config_srcpath="${parent}/home"
readonly home_config_dstpath=~

# List files in a directory which is specified as an argument. Each files are
# preceded by the directory path.
function list_files () {
  local src="${1%%*(/)}"

  if [[ ! -d "$src" ]]; then
    warning "$src is not directory."
    return 1
  fi

  local GLOBIGNORE="$src/*~"
  printf '%s\n' "$src"/*
}

# Make symbolik links from files in source directory to in destination
# directory.
function links () {
  local -r src_dir="${1%%*(/)}"
  local -r dst_dir="${2%%*(/)}"

  # validations
  if [[ ! "$src_dir" =~ ^/ ]]; then
    error "Source directory is not absolute path '$src_dir'"
    return 1
  fi

  if [[ ! -d "$src_dir" ]]; then
    error "No such source directory '$src_dir'"
    return 1
  fi

  if [[ ! "$dst_dir" =~ ^/ ]]; then
    error "Destination directory is not absolute path '$dst_dir'"
    return 1
  fi

  if [[ ! -d "$dst_dir" ]]; then
    error "No such destination directory '$dst_dir'"
    return 1
  fi

  list_files "$src_dir" | while read -r -d $'\n' link_src; do
    local f_base="${link_src##*/}"
    local link_dst="${dst_dir}/${f_base}"

    if [[ -a "${link_dst}" ]]; then
      warning "Skip linking from ${link_src} to ${link_dst} because ${f_base} has already existed in ${dst_dir}."
    else
      command ln -sv "$link_src" "$link_dst"
    fi
  done
}

function has_same_resolved_path () {
  local p1 p2
  p1="$(realpath "$1")"
  p2="$(realpath "$2")"

  [[ "$p1" == "$p2" ]]
}

# Remove symbolic links from destination directory.
function unlinks () {
  local -r src_dir="${1%%*(/)}"
  local -r dst_dir="${2%%*(/)}"

  # validations
  if [[ ! "$src_dir" =~ ^/ ]]; then
    error "Source directory is not absolute path '$src_dir'"
    return 1
  fi

  if [[ ! -d "$src_dir" ]]; then
    error "No such source directory '$src_dir'"
    return 1
  fi

  if [[ ! "$dst_dir" =~ ^/ ]]; then
    error "Destination directory is not absolute path '$dst_dir'"
    return 1
  fi

  if [[ ! -d "$dst_dir" ]]; then
    error "No such destination directory '$dst_dir'"
    return 1
  fi

  list_files "$src_dir" | while read -r -d $'\n' link_src; do
    local f_base="${link_src##*/}"
    local link_dst="${dst_dir}/${f_base}"

    if [[ ! -h "$link_dst" ]]; then
      warning "Skip unlinking $link_dst because no such link."
      continue
    fi

    if ! has_same_resolved_path "$link_src" "$link_dst"; then
      warning "Skip unlinking $link_dst because the link is not under control of this repository."
      continue
    fi

    command unlink "$link_dst" && echo "unlink: $link_dst"
  done
}

function deploy_bins () {
  links "$bin_srcpath" "$bin_dstpath"
}

function deploy_configs () {
  links "$config_srcpath" "$config_dstpath"
}

function deploy_home_configs () {
  links "$home_config_srcpath" "$home_config_dstpath"
}

function undeploy_bins () {
  unlinks "$bin_srcpath" "$bin_dstpath"
}

function undeploy_configs () {
  unlinks "$config_srcpath" "$config_dstpath"
}

function undeploy_home_configs () {
  unlinks "$home_config_srcpath" "$home_config_dstpath"
}

function deploy () {
  deploy_bins
  deploy_configs
  deploy_home_configs
}

function undeploy () {
  undeploy_bins
  undeploy_configs
  undeploy_home_configs
}

function init () {
  mkdir -vp \
    ~/bin \
    ~/.config \
    ~/.cache \
    ~/.local/share \
    ;
}

# main

# Argument array
declare -a args=()

# Parse arguments
while (( $# )); do
  case "$1" in
    --debug )
      set -x
      shift
      ;;
    -h | --help )
      help
      exit 0
      ;;
    -* )
      error "Invalid option '$1'"
      exit 1
      ;;
    * )
      args+=("$1")
      shift
      ;;
  esac
done

case "${args[0]}" in
  init )
    init
    ;;
  deploy )
    deploy
    ;;
  undeploy )
    undeploy
    ;;
  * )
    error "Invalid subcommand '${args[0]}'"
    exit 1
    ;;
esac

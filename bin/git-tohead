#!/bin/bash

set -euo pipefail

wrap () {
  local -r left="$1"
  local -r right="$2"

  echo -n -e "$left"
  while read -r; do
    echo -e "$REPLY"
  done
  echo -n -e "$right"
}

error () {
  wrap '\033[31m' '\033[m' <<<"$*"
}

is_upstream_configured () {
  git remote | grep -q '^upstream$'
}

is_upstream_head_configured () {
  git branch -r -l upstream/HEAD | read -r
}

configure_upstream_head () {
  git remote set-head upstream -a
}

to_origin_head () {
  git switch -d origin/HEAD
}

to_upstream_head () {
  git switch -d upstream/HEAD
}

while (( $# )); do
  case "$1" in
    -h | --help )
  echo -n "\
Descriptions:
  Detach to HEAD in upstream, otherwise in origin as fallback. If upstream is
  configured but no HEAD configuration in the repository, this command tries to
  configure it automatically.

Usage:
  git tohead
"
      exit 0
      ;;
    * )
      error "An unknown option: $1"
      exit 1
      ;;
  esac
done

if ! is_upstream_configured; then
  to_origin_head
  exit
fi

if is_upstream_head_configured; then
  to_upstream_head
  exit
fi

configure_upstream_head

if is_upstream_head_configured; then
  to_upstream_head
else
  to_origin_head
fi

# vim: expandtab tabstop=2 shiftwidth=2 foldmethod=marker:
